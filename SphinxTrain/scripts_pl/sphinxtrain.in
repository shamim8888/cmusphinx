#!/usr/bin/python

sphinxpath="@prefix@"

import getopt, sys, os

def setup(task):
    print "Setting up the database " + task
    out_cfg = open("etc/sphinx_train.cfg", "w")
    for line in open(sphinxpath + "/lib/sphinxtrain/etc/sphinx_train.cfg", "r"):
	line = line.replace("___DB_NAME___", task).replace("___BASE_DIR___", os.getcwd()).replace("___SPHINXTRAIN_DIR___", sphinxpath + "/lib/sphinxtrain")
	out_cfg.write(line)
    out_cfg = open("etc/feat.params", "w")
    for line in open(sphinxpath + "/lib/sphinxtrain/etc/feat.params", "r"):
	out_cfg.write(line)

steps = [
"000.comp_feat/slave_feat.pl",
"00.verify/verify_all.pl",
"01.lda_train/slave_lda.pl",
"02.mllt_train/slave_mllt.pl",
"05.vector_quantize/slave.VQ.pl",
"10.falign_ci_hmm/slave_convg.pl",
"11.force_align/slave_align.pl",
"12.vtln_align/slave_align.pl",
"20.ci_hmm/slave_convg.pl",
"30.cd_hmm_untied/slave_convg.pl",
"40.buildtrees/slave.treebuilder.pl",
"45.prunetree/slave.state-tying.pl",
"50.cd_hmm_tied/slave_convg.pl",
"60.lattice_generation/slave_genlat.pl",
"61.lattice_pruning/slave_prune.pl",
"62.lattice_conversion/slave_conv.pl",
"65.mmie_train/slave_convg.pl",
"90.deleted_interpolation/deleted_interpolation.pl",
"decode/slave.pl"
]

def run():
    print "Running the training"
    for step in steps:
	os.system(sphinxpath + "/lib/sphinxtrain/scripts_pl/" + step)

def usage():
    print "Usage: sphinxtrain [options] <command>"
    print ""
    print "Commands:"
    print "     -t <task> setup - copy configuration into database"
    print "     run - run the training"

def main():

    try:
        opts, args = getopt.getopt(sys.argv[1:], "ht:", ["help", "task"])
    except getopt.GetoptError, err:
        print str(err)
        usage()
        sys.exit(-1)
        
    task = None
        
    for o, a in opts:
	if o in ("-t", "--task"):
	    task = a
	if o in ("-h", "--help"):
    	    usage()
    
    if len(args) == 0:
	usage()
	sys.exit(-1)
    
    command = args[0]
    
    if command == "setup":
	if task == None:
	    print "No task name defined"
	    sys.exit(-1)	
	setup(task)
    if command == "run":
	run()
    	    
if __name__ == "__main__":
    main()
